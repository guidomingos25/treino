// app.js
import express from "express";
import oracledb from "oracledb";

const app = express();
const PORT = 3000;

// Conexão Oracle (exemplo — ajuste com suas credenciais)
const dbConfig = {
  user: "xlsuser",
  password: "xlsuser",
  connectString: "SERVIDOR:1521/NOME_DO_SERVICO"
};

app.get("/", async (req, res) => {
  let connection;

  try {
    connection = await oracledb.getConnection(dbConfig);
    const result = await connection.execute(`
      SELECT
          v_arm_expedicaocargas.*,
          SYSDATE AS ULTIMA_ATUALIZACAO
      FROM
          v_arm_expedicaocargas
      WHERE
          TO_DATE("DATA DE SOLICITACAO", 'DD/MM/YYYY HH24:MI:SS') >= TRUNC(SYSDATE) - 60
    `);

    // Converte os resultados em JSON
    const rows = result.rows || [];
    const columns = result.metaData.map(c => c.name);

    // Gera uma tabela HTML diretamente aqui
    let html = `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8">
      <title>Consulta de Cargas</title>
      <style>
        body { font-family: Arial; background: #f9fafb; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background: #007bff; color: white; }
      </style>
    </head>
    <body>
      <h1>Consulta de Cargas</h1>
      <p>Última atualização: ${new Date().toLocaleString()}</p>
      <table>
        <thead><tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr></thead>
        <tbody>
          ${rows.map(r => `<tr>${r.map(v => `<td>${v ?? ''}</td>`).join('')}</tr>`).join('')}
        </tbody>
      </table>
    </body>
    </html>
    `;

    res.send(html);

  } catch (err) {
    console.error(err);
    res.status(500).send("Erro ao consultar o banco de dados.");
  } finally {
    if (connection) await connection.close();
  }
});

app.listen(PORT, () => console.log(`Servidor rodando em http://localhost:${PORT}`));
